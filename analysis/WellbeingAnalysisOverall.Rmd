---
title: "CausalFeatureEngineering"
author: "Uli Kaulfuss"
date: "17 Januar 2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(42)

library(foreign)
# library(readstata13)
library(dplyr)
library(naniar)
library(glmnet)
library(ggplot2)
library(MASS)
library(Hmisc)
library(reshape2)
library(cluster)
library(VIM)
library(readxl)
library(gdata)
library(caret)
library(nnet)
library(dummies)
library(car)
library(knitr)
library(kableExtra)
library(stargazer)
library(MatchIt)


# library(performanceEstimation)


```

# Objective

The purpose of this analysis is to understand and quantify the different drivers that contribute to good wellbeing (good / very good = GZmehm1) in order to give individual advice to improve peoples' lives.

The response variable GZmehm1 is a rating of individual wellbeing on a 5-step scale 1= very bad | 5=very good. 

```{r, echo=F}
load(file = "data/geda_data.RData")
hist(as.numeric(df_geda_num[!is.na(df_geda_num$GZmehm1),]$GZmehm1), breaks=.5:5.5, main="Histogram of the wellbeing score (response)", xlab="1=very bad | 5=very good")
```


```{r, echo=F}
# Import data dictionary / meta data of responses

df_meta_lvls <- read_excel("data.doc/GEDA14_Variablenuebersicht_Analyse.xlsx", sheet='levels')
df_meta_lvls$numLevel <- as.numeric(df_meta_lvls$numLevel)
```

# Feature engineering: 
Combining features for causal analysis in accordance with the survey

```{r, echo=F}

# Load all the variables that seem relevant in the raw first place

df_overall <- df_geda_num %>% dplyr::select(c(
ABschichtC, #Shift and night work
ABsubjB, #Health risk from work
ABtragen, #Lifting and / or carrying heavy loads
age5B, #Age (5-year groups)
AKbingeC_k, #Binge drinking (> = 6 alk. Drinks. On one occasion) in 4 Cat.
AKechi47, #Hazardous alcohol consumption (ECHI 47;> 20/40 g / day)
AKoft12_k, #Alcohol i.d.l. 12 months in 6 Cat.
AKrisiko, #Hazardous alcohol consumption (> 20.10 g / day)
AKrisiko2, #Hazardous alcohol consumption (> 20.10 g / day) 4 Kat.
AMarztB, #Taking medications v. Doctor prescribed i.d.l. 2 Where
AMfrei, #v not taking medication. Doctor prescribed i.d.l. 2 Where
AUarbC, #not due to illness to work: I.d.l. 12 Mon.
AUarbzD_k, #not due to illness to work: weeks
BBbehB, #Officially recognized disability
BBbehzC_k, #kat degree of disability.
BBblas12B, #Urinary incontinence: I.d.l.12 Mon.
BBdors112, #Lower back pain: I.d.l.12 Mon.
BBdors212, #Complaints neck, cervical spine: I.d.l.12 Mon.
BBgehen, #Schwierigk. when walking without walking aids at 500m
BBmyo12, #Chronic pain after heart attack: I.d.l.12 Mon.
BBsa12, #Chronic plaints. following a stroke: I.d.l.12 Mon.
BBtreppe, #Schwierigk. Staircase with 12 steps
BLpflege2C, #Support / care of others
BLpflegedauB, #Support / Care: Hours per week
bula, #state
ENgemB, #Consumption of vegetables
ENgemBz1, #Consumption of vegetables: per day
ENobstB, #Consumption of fruit
ENobstBz1, #Consumption of fruits: per day
GVasku1, #Reliance on prop. Diffic skills. situations
GZmehm1, #Gen. health status
GZmehm2D, #Limited by disease for min. 6 months
GZmehm3C, #Chronic diseases
GZsubj1, #Pay attention to health
IAambC, #Day patient in the hospital i.d.l. 12 Mon.
IAambC_k, #Day patient in the hospital i.d.l. 12 month .: number of shots (top coding 10 or more)
IAarzt14B, #Dental examination
IAarzt1B, #Visit general practitioners or family doctor
IAarzt1B12_k, #Visit general practitioners or family doctor i.d.l. 12 month .: Number (top coding 20 or more)
IAarzt1B4w, #Visit general practitioners or family doctor i.d.l. 4 weeks: Number
IAarzt8C, #Visit psychologists i.d.l. 12 Mon.
IAcholus, #Last blood fat determination
IAdiabus, #Last blood glucose monitoring
IAfa, #Visiting Specialist
IAfa12_k, #Visiting Specialist i.d.l. 12 month .: Number (top coding 20 or more)
IAfa4w, #Visiting Specialist i.d.l. 4 weeks: Number
IAhypus, #Last blood pressure measurement
IAkfutyp2B_lz, #Last stool test
IAkfutyp4B_lz, #Last colonoscopy
IAkfutyp5B_lz, #Last cervical smear
IAkfutyp7B_lz, #Last mammography
IAkfutyp7Bgr, #Reason for the last mammogram
IAkhs, #Stationary i.d.l. in hospital 12 Mon.
IAkhs_k, #Stationary i.d.l. in hospital 12 month .: Number of nights (cat)
IAkosten1, #US Required / n treatment. Affordable i.d.l. 12 month .: Physicians. US / treatment
IAkosten2, #US Required / n treatment. Affordable i.d.l. 12 month .: Zahnärztl. US / treatment
IAkosten3, #US Required / n treatment. Affordable i.d.l. 12 month .: Prescribed Med.
IAkosten4, #US Required / n treatment. Affordable i.d.l. 12 month .: US / psy treatment. Prob.
IAkv1D, #Health Insurance in 3 Cat.
IApflege, #Use of home care services: I.d.l. 12 Mon.
IAtermin, #i.d.l. waiting for examination appointment 12 Mon.
IAther2B, #Visit physiotherapists i.d.l. 12 Mon
IAweg, #Investigation delayed due i.d.l. Distance 12 Mon.
IPinfl1314B, #Flu vaccination winter season 2013/2014 generated
IPinfl1415B, #Flu vaccination winter season 2014/2015 generated
IPinfl4, #Last flu shot
IPinfl4_jj, #Last flu shot: Year
IPinfl4_mm, #Last flu shot: Month
IPinfl6B, #Frequency flu vaccine generated
IPtet, #Ever tetanus vaccination
IPtet_lz, #Last tetanus shot
KAabka, #Moderate to very strenuous arbeitsbez. körp. activity
KAehispaq1, #Activities (effort)
KAehispaq2, #Movement on foot: days a week
KAehispaq3, #Movement on foot: Duration
KAehispaq4, #Movement with bicycle: days a week
KAehispaq5, #Movement with bicycle: Duration
KAehispaq6, #Sports: days a week
KAehispaq8, #Building / strengthening: days a week
KAgfa, #> = 150 min Ausdaueraktiv.und 2x / week Active. for Muskelkräft. (stop. WHO both Sens.)
KAgfka, #Stop. aerobic WHO Bew.empf. (With Go> = 150 min. Aerobic körp. Aktiv./Wo)
KAgfka1, #Stop. aerobic WHO Bew.empf. (O. Go> = 150 aerobic körp. Aktiv./Wo min.)
KAgfmk, #WHO Rec. to Muskelkräft. (> = 2x / wk. Activities. To strengthen the muscles)
KAgka, #Sufficient körp. active during work or leisure
KAgka_k, #total activity
KAsabka, #Very strenuous work-related physical activity
KAspodauC_k, #Sports week in total (category Siert in 30 min)
KAtbka_k, #Transportbez. körp. Activity in MET / hours / week (top coding from 100h)
KHab12, #Asthma: I.d.l.12 Mon.
KHalgi112, #Allergies: I.d.l. 12 Mon.
KHbbmyo12, #Heart attack / chron. Plaints .: I.d.l. 12 Mon.
KHbbsa12, #Stroke / chron. Complaints resulting SA: I.d.l.12 Mon.
KHcb12, #Chronic bronchitis: I.d.l.12 Mon.
KHced12, #Inflammatory bowel disease: I.d.l.12 Mon.
KHcle12, #Other chronic liver diseases: I.d.l.12 Mon.
KHdge12, #Osteoarthritis: I.d.l.12 Mon.
KHdiabB12, #Diabetes: I.d.l.12 Mon.
KHhi12, #Heart failure: I.d.l.12 Mon.
KHhyp, #Hypertension: Ever diagnosed medically
KHhyp12, #Hypertension: I.d.l.12 Mon.
KHhyp12pB, #Indicator bek. (Ärztl. Diagn.) Hypertension pressure i.d.l. 12 Mon
KHhypmedC, #Indicator antihypertensive agents with known hypertension
KHkarz12, #Cancer: I.d.l.12 Mon.
KHkhk12, #Coronary heart disease / angina pectoris: I.d.l.12 Mon.
KHlip12A, #Elevated blood lipids / Chol .: I.d.l.12 Mon.
KHlipA, #Ever elevated blood lipids / Cholesterinw. (Physician diagnosis)
KHlipmedA, #Elevated cholesterol: Currently taking medication
KHlz12, #Cirrhosis: I.d.l.12 Mon.
KHmyo12, #Heart Attack: I.d.l. 12 Mon.
KHniB12, #. Chronic kidney problems: I.d.l.12 Mon.
KHos12, #Osteoporosis: I.d.l.12 Mon.
KHra12, #Arthritis: I.d.l.12 Mon.
KHsa12, #Stroke: I.d.l.12 Mon.
KHulc12, #Gastric or duodenal ulcer: I.d.l.12 Mon.
LQsf367C, #Strength pain i.d.l. 4 weeks
LQsf368C, #Disability in daily activities due to pain i.d.l. 4 weeks
LQzufrB10, #overall life satisfaction
MIbirthplace, #Country of birth (EHIS)
MIcitizen, #nationality
PAadiposB, #Obesity according to WHO (BMI> = 30; from self-declaration)
PAbmiB_k, #BMI moiety (from self-specification)
PAbmiB_k2, #BMI grouping detaill. (From self-specification)
PAfam3, #Living together in marriage or cohabitation
PAgewiB, #Body weight (self-specification) [kg]
PAgroe, #Height (self-specification) [cm]
PAhh_k, #Number of people in household (cat.)
PAhhtype, #household type
PAueberB, #Obesity according to WHO (BMI> = 25; from self-declaration)
PKdep12, #Depression: I.d.l. 12 Mon.
PKphq1, #Adversely. i.d.l. 2 Where .: Little interest / pleasure in your activities
PKphq2, #Adversely. i.d.l. 2 Where .: dejection, melancholy / hopelessness
PKphq3, #Adversely. i.d.l. 2 Where .: Schwierigk., On / od asleep. Increased sleep
PKphq4, #Adversely. i.d.l. 2 Where .: fatigue / feeling, k. to have power
PKphq5, #Adversely. i.d.l. 2 Where .: Vermind. Appetite / excessive need to eat
PKphq6, #Adversely. i.d.l. 2 Where v .: Poor opinion. yourself; to disappointments failure / family.
PKphq7, #Adversely. i.d.l. To focus 2 Where .: Schwierigk.
PKphq8, #Adversely. i.d.l. 2 Where .: change in movement or speech
PKphq8diag, #PHQ-8: Diagnostic Cat.
RC_ak, #Start smoking: age (cat.)
RCex_ak, #End Smoking: age (cat.)
RCpass4, #Smoking in enclosed spaces
RCpassort_m1, #Passive smoking: Work
RCpassort_m2, #Passive Smoking: at home
RCpassort_m3, #Passive smoking: pubs / cafes / bars / disco
RCpassort_m4, #Passive smoking restaurant
RCpassort_m5, #Passive smoking: friends / acquaintances
RCpassort_m6, #Passive smoking: Change village
RCpassort_m7, #Passive smoking: public. building
RCstat, #Smoke
RCtyp_m1, #Tobacco products: Factory-built cigarettes
RCtyp_m2, #Tobacco Products: Hand-rolled cigarettes
RCtyp_m3, #Tobacco products: cigars, cigarillos
RCtyp_m4, #Tobacco products: pipe tobacco
RCtyp_m6, #Tobacco products: Miscellaneous
RCtyp_m7, #Tobacco Products: E-Cigarette
RCtyphaupt, #Mainly smoked Takabprodukt
RCz2B_ttk, #Hand-rolled cigarettes daily: (cat.) Number
RCz2B_wwk, #-Rolled cigarettes weekly: Quantity (kat)
RCzA_ttk, #Daily. Smoking: Tgl. Number of cigarettes (cat.)
RCzA_wwk, #Cigarettes weekly (cat.) No.
SDaeqeink_k, #Equivalent income (imputed, kat) [€]
SDalo, #Unemployed i.d.l. 5 years
SDalo_mmk, #Unemployed: total months i.d.l. 5 years (cat.)
SDalogz, #Change in health by unemployment
SDalokh, #Unemployment to do with disease
SDbest, #Professional status in main job
SDbest_lz, #Professional status in last main job
SDbild1D, #Highest general. Bildener school
SDbild4C, #Highest berufl. Training or university / college degree
SDbverh, #Type of last employment
SDbverh2, #Type of employment
SDerwt0a, #Life situation currently
SDetoed, #Main job in public. service
SDft_pt, #Full or part time employment
SDfuehr, #Recent activity primarily as a management supervisor
SDfuehr2, #Activity primarily as a management supervisor
SDhhincomez, #Monthly. (Imputed) HH net income into quintiles
SDhvtypD, #Breadwinner in the household
SDjobstat, #Professional status
SDmainstat, #Employment (EHIS)
SDses, #Socioeconomic status (SES)
SEschwA_zz, #Pregnant at the time
sex, #gender
SFoslo1C, #Related parties
SFoslo2C, #Participation of other persons
SFoslo3A, #Getting Help
SFosloA, #Social support (Oslo 3 Social Support Scale)
SHhoer1, #hearing Aid
SHhoer5, #Schwierigk. even with hearing aids: Quiet room
SHhoer6, #Schwierigk. even with hearing aids: Loud room
SHseh1, #Glasses or Contacts
SHseh2C, #Difficulties even with glasses or contact lenses
UVarbeit1, #Injury accident at work: I.d.l. 12 months (no way accident)
UVarbeit2, #Injury accident at work: medicine. provided (no way accident)
UVartfreiz, #Wg injury. Accident i.d.l. 12 months: Accident in leisure
UVarthaus, #Wg injury. Accident i.d.l. 12 months: Accident at home
UVartverkehr, #Wg injury. Accident i.d.l. 12 months: Traffic accident
UVarztE_k #Medical care after an accident three Cat.
))
```

#### Initially we want to set a baseline analysis of overall drivers for wellbeing crossing the entire population in Germany

Ensure that the correct encoding (factor, numeric, ...) is applied according to the meta data from base dataset before for further feature enginering

```{r right-coding of data types, echo=F}

for (i in colnames(df_overall)){
  
  col_meta <- df_meta_lvls[df_meta_lvls$Varname == i,]
  
  col_type <- col_meta[1,]$Type
  
  if(nrow(col_meta) > 0){
    
    if (col_type == 'Nominal' |col_type == 'Ordinal' ){
      
      unique_lvls <- unique(df_geda_de[[i]])
      
      # for text columns, change data to factors 
      
      df_overall[[i]] <- factor(df_overall[[i]], levels=col_meta$numLevel, labels=col_meta$numLevel)
      
    }else if (col_type == "Scale"){
      
      unique_lvls <- unique(col_meta)
      
      for (row_it in 1:nrow(col_meta)){
        
        l <- col_meta[row_it,]$textLevel
        
        if (!is.na(l) & l != ""){
        
          df_overall[[i]][df_overall[[i]] == l] <- col_meta[col_meta$textLevel == l,]$numLevel
          
        }
        
      }
      
      # for scale columns, change datatype to numeric 
      df_overall[[i]]<- as.numeric(df_overall[[i]])
      
    }
      # add variable label, access this with Hmisc-functions like describe(%dataframe%)
      
      label(df_overall[[i]]) <- col_meta[1,]$VarLabel
      
      
  }else{
    print(paste(i, ": type: ", col_type))
  }
  
}

```

## Feature engineering 
Combine a new feature "how many portions do you eat vegies/fruit per day in a week?"
People that have 4 to 6 portions of fruit per week have (coded = 2) on average 5 portions per week => 5 portions / 7 days in a week

```{r}
df_overall[df_overall$ENobstB == 2 & !is.na(df_overall$ENobstBz1),]$ENobstBz1 = round(5/7,2)
df_overall[df_overall$ENobstB == 3 & !is.na(df_overall$ENobstBz1),]$ENobstBz1 = round(2/7,2)
df_overall[df_overall$ENobstB == 4 & !is.na(df_overall$ENobstBz1),]$ENobstBz1 = round(1/7,2)
df_overall[df_overall$ENobstB == 5 & !is.na(df_overall$ENobstBz1),]$ENobstBz1 = 0

df_overall$ENobstBz1 <- as.numeric(df_overall$ENobstBz1)

# deselect the question 
df_overall<- df_overall %>% dplyr::select(-ENobstB)
```

Do the same with veggies.
people that have 4 to 6 portions of vegies per week have (coded = 2) on average 5 portions per week => 5 portions / 7 days in a week

```{r}
df_overall[df_overall$ENgemB == 2 & !is.na(df_overall$ENgemBz1),]$ENgemBz1 = round(5/7,2)
df_overall[df_overall$ENgemB == 3 & !is.na(df_overall$ENgemBz1),]$ENgemBz1 = round(2/7,2)
df_overall[df_overall$ENgemB == 4 & !is.na(df_overall$ENgemBz1),]$ENgemBz1 = round(1/7,2)
df_overall[df_overall$ENgemB == 5 & !is.na(df_overall$ENgemBz1),]$ENgemBz1 = 0

df_overall$ENgemBz1 <- as.numeric(df_overall$ENgemBz1)

# deselect the question 
df_overall<- df_overall %>% dplyr::select(-ENgemB)
```

Aggregate types of schools within German school system

```{r}
df_overall[(df_overall$SDbild1D == 8 | df_overall$SDbild1D == 1 | df_overall$SDbild1D == 2 | df_overall$SDbild1D == 3) & !is.na(df_overall$SDbild1D),]$SDbild1D <- 2
df_overall[(df_overall$SDbild1D == 3 | df_overall$SDbild1D == 4 | df_overall$SDbild1D == 5) & !is.na(df_overall$SDbild1D) ,]$SDbild1D <- 5
df_overall[(df_overall$SDbild1D == 6 | df_overall$SDbild1D == 7) & !is.na(df_overall$SDbild1D) ,]$SDbild1D <- 7

df_overall$SDbild1D <- drop.levels(df_overall$SDbild1D)

```

Encode minutes of sports during week as integer (1 unit == 30 minutes); -96 == no sport == 0 minutes

```{r}
df_overall[df_overall$KAspodauC_k == '-96' & !is.na(df_overall$KAspodauC_k),]$KAspodauC_k <- 0

df_overall$KAspodauC_k <- as.numeric(df_overall$KAspodauC_k)

```

Encode days mnissed due to sickness in numeric values (1 == 1 week == 7 days missed due to sickness)

```{r}
df_overall$AUarbzD_k <- as.numeric(df_overall$AUarbzD_k)
```

Set NA to values where people are not being asked about tetanus vaccinations

```{r}
df_overall[(df_overall$IPtet_lz == '-96' | df_overall$IPtet_lz == '-95' ) & !is.na(df_overall$IPtet_lz),]$IPtet_lz <- NA
```

Encode number of GP visited in the last 4 weeks --> if -96, then 0 

```{r}
df_overall[df_overall$IAarzt1B4w == '-96' & !is.na(df_overall$IAarzt1B4w),]$IAarzt1B4w <- 0

df_overall$IAarzt1B4w <- as.numeric(df_overall$IAarzt1B4w)
```

Encode number of GP visited in the last 12 months --> if -96, then 0 (added on 4/1 by AA)

```{r}
df_overall$IAarzt1B <- as.numeric(df_overall$IAarzt1B)

#subtract 1 given it updates the values in the original data set (Added 4.1.20)
df_overall$IAarzt1B <- df_overall$IAarzt1B -1

# if 1 = 1, all else = 0 (represent if you have visited doctor in the last 12 months) (added 4.1.20)
df_overall$IAarzt1B[df_overall$IAarzt1B == 1] <- 0
df_overall$IAarzt1B[df_overall$IAarzt1B >= 2] <- 1

```


Set NA to values where people left values blank for SDbild4C (Highest berufl. Training or university / college degree) and SDbverh2 (Type of employment)

```{r}
#df_overall$SDbild4C[df_overall$SDbild4C >= "-96"] <- NA #ADDED 4.1.20
#df_overall$SDbverh2[df_overall$SDbverh2 >= "-96"] <- NA #ADDED 4.1.20
```



Encode number of specialist visited in the last 12 months --> if -96, then 0 

```{r}
df_overall[df_overall$IAfa4w == '-96' & !is.na(df_overall$IAfa4w),]$IAfa4w <- 0

df_overall$IAfa4w <- as.numeric(df_overall$IAfa4w)
```

Encode IAkhs_k as numeric where 1 unit == 7 days == 1 week spent in hospital 

```{r}
df_overall$IAkhs_k <- as.numeric(df_overall$IAkhs_k)
```

Encode if the individual has had any injuries due to an accident in the past 12 months

```{r}
df_overall$flagHadAccident <-  ifelse( is.na(df_overall$UVartverkehr) & is.na(df_overall$UVarthaus) & is.na(df_overall$UVartfreiz) & is.na(df_overall$UVarbeit1), NA, 
        
        ifelse(df_overall$UVartverkehr == 1 | df_overall$UVarthaus == 1 |df_overall$UVartfreiz == 1 |df_overall$UVarbeit1 == 1 , 
1,0))

df_overall$flagHadAccident <- factor(df_overall$flagHadAccident)
```


##### Ensuring that response is an ordered factor

```{r}
col_meta <- df_meta_lvls[df_meta_lvls$Varname == 'GZmehm1',]

df_overall$GZmehm1 <- ordered(df_overall$GZmehm1, levels=col_meta[order(col_meta$numLevel),]$numLevel, labels=col_meta[order(col_meta$numLevel),]$numLevel)

describe(df_overall$GZmehm1)
```

## Feature selection:

Out of all the possible columns - select the functioanlly relevant ones, drop too granular ones and include the newly engineered features for modelling.
As of now, factors that are purely relevant for one sex (e.g. pregnancy) are not included.

Thus, variables of the following six blocks are included: 

* master data about the person
* socio economic data
* way of life
* health care 
* health situation and conditions
* psychological health

```{r}
curr_cols <- c(
  
  # step 1: master data
  'sex', #Geschlecht
  "age5B", #Alter (5-Jahres-Gruppen)
  "MIbirthplace", #Geburtsland (EHIS)
  "MIcitizen", #Staatsangehörigkeit
  "bula", #Bundesland
  "PAgroe", #Körpergröße (Selbstangabe) [cm]
  "PAgewiB", #Körpergewicht (Selbstangabe) [kg]
  "IAkv1D", #Krankenversicherung in 3 Kat.
  
  # step 2: socio economic data
  "SDaeqeink_k", #Äquivalenzeinkommen (imputiert,kat) [€]
  "SDbild4C", #Höchster berufl. Ausbildungs- oder Hochschul/Fachhochschulabschluss
  "SDbverh2", #Art des Beschäftigungsverhältnisses
  "SDhvtypD", #Hauptverdiener im Haushalt
  "SDmainstat", # Erwerbstätigkeit
  "SDalo", #Arbeitslos i.d.l. 5 Jahren, 
  "PAhhtype", #Haushaltstyp
  
  # step 3: way of life
  "ENobstBz1",  #Verzehr von Obst: pro Tag
  "ENgemBz1", #Verzehr von Gemüse: pro Tag
  "AKoft12_k", #Alkohol i.d.l. 12 Mon. in 6 Kat.
  "RCstat",  # Smoking
  "KAehispaq2", #Bewegung zu Fuß: Tage pro Woche
  "KAehispaq4", #Bewegung mit Fahrrad: Tage pro Woche
  "KAspodauC_k", #Sport pro Woche insgesamt (in 30 min kategoriesiert)
  "KAehispaq8", #Aufbau/Kräftigung: Tage pro Woche
  "KAgfka", #Einhalt. aerobe WHO-Bew.empf. (mit Gehen >= 150 Min. aerobe körp. Aktiv./Wo)
  "KAgfa", #>= 150 min Ausdaueraktiv.und 2 x/ Woche Aktiv. zur Muskelkräft.(Einhalt. beider WHO-Empf.)
  "KAgfka1", #Einhalt. aerobe WHO-Bew.empf. (o. Gehen >= 150 Min. aerobe körp. Aktiv./Wo)
  "KAgfmk", #WHO-Empf. zur Muskelkräft. (>= 2x/Wo. Aktivit. zur Muskelkräftigung)
  
  # step 4: health care
  "IPinfl4", #Letzte Grippeimpfung
  "IPinfl6B", #Häufigkeit Grippeimpfung, generiert
  "IPtet_lz", #las tetanus vaccination --> flag cannot be used since there are only "YES" tetanus vaccinated people
  "AMarztB", #Einnahme Medikamente v. Arzt verschrieben i.d.l. 2 Wo
  "AMfrei", #Einnahme Medikamente nicht v. Arzt verschrieben i.d.l. 2 Wo
  "AUarbzD_k", #Krankheitsbedingt nicht zur Arbeit: Wochen
  "IAhypus", #Letzte Blutdruckmessung
  "IAcholus", #Letzte Blutfettwertebestimmung
  "IAdiabus", #Letzte Blutzuckermessung
  "IAkfutyp2B_lz", #Letzter Stuhltest
  "IAkfutyp4B_lz", #Letzte Darmspiegelung
  # exclude as of now, since only relevant for women: IAkfutyp7B_lz, #Letzte Mammografie
  # exclude as of now, since only relevant for women: IAkfutyp7Bgr, #Grund für die letzte Mammografie
  # exclude as of now, since only relevant for women: IAkfutyp5B_lz, #Letzter Gebärmutterhalsabstrich
  "IAtermin", #Auf Untersuchungstermin gewartet i.d.l. 12 Mon.
  "IAweg", #Untersuchung verzögert wegen Entfernung i.d.l. 12 Mon.
  # IAkosten1, #Benötigte US/Behandlung n. bezahlbar i.d.l. 12 Mon.: Ärztl. US/Behandlung
  # IAkosten2, #Benötigte US/Behandlung n. bezahlbar i.d.l. 12 Mon.: Zahnärztl. US/Behandlung
  # IAkosten3, #Benötigte US/Behandlung n. bezahlbar i.d.l. 12 Mon.: Verordnete Med.
  # IAkosten4, #Benötigte US/Behandlung n. bezahlbar i.d.l. 12 Mon.: US/Behandlung psy. Prob.
  "IAarzt14B", #Zahnmedizinische Untersuchung
  "IAarzt1B4w", #Besuch Allgemeinarzt oder Hausarzt i.d.l. 4 Wochen: Anzahl
  "IAarzt1B", #Visit doctor in the last 12 months (Added on April 1st, part of causal analysis)
  "IAfa4w", #Besuch Facharzt i.d.l. 4 Wochen: Anzahl
  "IAarzt8C", #Besuch Psychologen i.d.l. 12 Mon.
  "IAkhs", #Stationär im Krankenhaus i.d.l. 12 Mon.
  "IAkhs_k", #Stationär im Krankenhaus i.d.l. 12 Mon.: Anzahl der Nächte (kat) --> encoded in # of weeks
  "IAther2B", #Besuch Physiotherapeuten i.d.l. 12 Mon
  "IApflege", #Inanspruchnahme häuslicher Pflegedienst: I.d.l. 12 Mon.
  
  # step 5: health conditions
  # exclude as of now, since only relevant for women: "SEschwA_zz", #Schwanger zur Zeit
  "GZmehm3C", #Chronische Krankheiten
  "GZmehm2D", #Einschränkung durch Krankheit seit mind. 6 Monaten
  "BBbehB", #Amtlich anerkannte Behinderung 
  "GZsubj1", #Achten auf Gesundheit
  "SHseh1", #Brille oder Kontaktlinsen
  "SHhoer1", #Hörgerät
  "LQsf367C", #Stärke Schmerzen i.d.l. 4 Wochen
  "LQsf368C", #Behinderung in Alltagstätigkeiten durch Schmerzen i.d.l. 4 Wochen
  "flagHadAccident" , # has had any injuries due to accidents in past 12 months
  "BBdors112", #Beschwerden unterer Rücken: I.d.l.12 Mon.
  "BBdors212", #Beschwerden Nacken, Halswirbelsäule: I.d.l.12 Mon.
  "BBblas12B", #Harninkontinenz: I.d.l.12 Mon.
  "BBgehen", #Schwierigk. beim Laufen ohne Gehhilfe auf 500m
  "BBtreppe", #Schwierigk. Treppe mit 12 Stufen
  "BBmyo12", #Chronische Beschwerden nach Herzinfarkt: I.d.l.12 Mon.
  "BBsa12", #Chronische Beschw. infolge eines Schlaganfalls: I.d.l.12 Mon.
  "KHhyp12", #Bluthochdruck: I.d.l.12 Mon.
  "KHhyp", #Bluthochdruck: Jemals ärztlich diagnostiziert
  "KHhyp12pB", #Indikator bek. (ärztl. diagn.) Bluthochdruckdruck i.d.l. 12 Mon
  "KHhypmedC", #Indikator blutdrucksenkende Mittel bei bekannter Hypertonie
  "KHmyo12", #Herzinfarkt: I.d.l. 12 Mon.
  "KHkhk12", #Koronare Herzerkrankung/Angina Pectoris: I.d.l.12 Mon.
  "KHbbmyo12", #Herzinfarkt/chron. Beschw.: I.d.l. 12 Mon.
  "KHhi12", #Herzinsuffizienz: I.d.l.12 Mon.
  "KHsa12", #Schlaganfall: I.d.l.12 Mon.
  "KHdiabB12", #Diabetes: I.d.l.12 Mon.
  "KHab12", #Asthma: I.d.l.12 Mon.
  "KHkarz12", #Krebserkrankung: I.d.l.12 Mon.
  "KHlip12A", #Erhöhte Blutfette/Chol.: I.d.l.12 Mon.
  "KHlipA", #Jemals erhöhte Blutfette/Cholesterinw. (Arztdiagnose)
  "KHlipmedA", #Erhöhtes Cholesterin: Zurzeit Medikamenteneinnahme
  "KHcb12", #Chronische Bronchitis: I.d.l.12 Mon.
  "KHulc12", #Magen- oder Zwölffingerdarmgeschwür: I.d.l.12 Mon.
  "KHced12", #Chronisch entzündliche Darmerkrankung: I.d.l.12 Mon.
  "KHlz12", #Leberzirrhose: I.d.l.12 Mon.
  "KHcle12", #Andere chronische Lebererkrankungen: I.d.l.12 Mon.
  "KHniB12", #Chron. Nierenprobleme: I.d.l.12 Mon.
  "KHdge12", #Arthrose: I.d.l.12 Mon.
  "KHra12", #Arthritis: I.d.l.12 Mon.
  "KHos12", #Osteoporose: I.d.l.12 Mon.
  "KHalgi112", #Allergien: I.d.l. 12 Mon.

  # step 6: psychological health
  "LQzufrB10", #Zufriedenheit: Leben insgesamt
  "PKdep12", #Depression: I.d.l. 12 Mon.
  "SFoslo1C", #Nahestehende Personen
  "SFoslo3A", #Erhalt von Hilfe
  "SFosloA" #Soziale Unterstützung (Oslo-3 Social Support Scale)
)

curr_cols_all <- append(curr_cols, "GZmehm1")

```

Preparing the data for modelling: 
* selection of relevant columns
* dropping superfluous levels
* removing NAs
* creating training/test spit for performance evaluation


```{r}
df_tmp <- df_overall %>% dplyr::select(curr_cols_all) 
df_tmp <- df_tmp[complete.cases(df_tmp),]
for (c in colnames(df_tmp)){
  df_tmp[[c]] <- drop.levels(df_tmp[[c]])
}
df_tmp <- df_tmp[complete.cases(df_tmp),]
```

## Testing for multicollinearity

It seems that the following variables suggest multicollinearity and thus are omitted:

```{r, echo=False}
options(scipen=999)
lm <- lm(GZmehm1 ~ ., data = (df_tmp %>% dplyr::mutate_all(as.character) %>% dplyr::mutate_all(as.numeric)))
variance_factors <- vif(lm)
variance_factors[variance_factors>9]
```

Additional checks on multicollinearity validate the removal of the variables selected in the prior step
```{r}
#Test Multicollinearity after the removal of all of the variables with high VIF: KHhyp12pB & KHbbmyo12
#Results: None
df_test1 <- df_tmp %>% dplyr::select(-c(KHhyp12pB, KHbbmyo12))
lm_test1 <- lm(GZmehm1 ~ ., data = (df_test1 %>% dplyr::mutate_all(as.character) %>% dplyr::mutate_all(as.numeric)))
variance_factors_test1 <- vif(lm_test1)
variance_factors_test1[variance_factors_test1>9]


#Test Multicollinearity after the removal of one of the variables with high VIF: KHhyp12pB
#Results: As expected, KHbbmyo12 came up with high multicol.
df_test2 <- df_tmp %>% dplyr::select(-c(KHhyp12pB))
lm_test2 <- lm(GZmehm1 ~ ., data = (df_test2 %>% dplyr::mutate_all(as.character) %>% dplyr::mutate_all(as.numeric)))
variance_factors_test2 <- vif(lm_test2)
variance_factors_test2[variance_factors_test2>9]


#Test Multicollinearity after the removal of one of the variables with high VIF: KHhyp12pB
#Results: As expected, KHhyp12pB came up with high multicol.
df_test3 <- df_tmp %>% dplyr::select(-c(KHbbmyo12))
lm_test3 <- lm(GZmehm1 ~ ., data = (df_test3 %>% dplyr::mutate_all(as.character) %>% dplyr::mutate_all(as.numeric)))
variance_factors_test3 <- vif(lm_test3)
variance_factors_test3[variance_factors_test3>9]
```


Our goal here is to run separate binary logistic regressions for different levels of the target variable (4 regressions if you have 5 levels), and see that the slopes are similar in all 4. The intercepts can be very different, that is consistent with the proportional odds model.
```{r}
#Check Parellel Slopes Assumption Holds
#psa = parallel slopes assumption

#health = 1
df_psa1 <- df_tmp %>% dplyr::select(-c(KHhyp12pB, KHbbmyo12))
df_psa1$GZmehm1 <- as.numeric(df_psa1$GZmehm1)
df_psa1$GZmehm1[df_psa1$GZmehm1 > 1] <- 0
logit_1 <- glm(GZmehm1 ~ .,family = binomial, data = df_psa1)

#health <= 2
df_psa2 <- df_tmp %>% dplyr::select(-c(KHhyp12pB, KHbbmyo12))
df_psa2$GZmehm1 <- as.numeric(df_psa2$GZmehm1)
df_psa2$GZmehm1[df_psa2$GZmehm1 <= 2] <- 1
df_psa2$GZmehm1[df_psa2$GZmehm1 > 2] <- 0
logit_2 <- glm(GZmehm1 ~ .,family = binomial, data = df_psa2)

#health <= 3
df_psa3 <- df_tmp %>% dplyr::select(-c(KHhyp12pB, KHbbmyo12))
df_psa3$GZmehm1 <- as.numeric(df_psa3$GZmehm1)
df_psa3$GZmehm1[df_psa3$GZmehm1 <= 3] <- 1
df_psa3$GZmehm1[df_psa3$GZmehm1 > 3] <- 0
logit_3 <- glm(GZmehm1 ~ .,family = binomial, data = df_psa3)

#health <= 4
df_psa4 <- df_tmp %>% dplyr::select(-c(KHhyp12pB, KHbbmyo12))
df_psa4$GZmehm1 <- as.numeric(df_psa2$GZmehm1)
df_psa4$GZmehm1[df_psa4$GZmehm1 <= 4] <- 1
df_psa4$GZmehm1[df_psa4$GZmehm1 > 4] <- 0
logit_4 <- glm(GZmehm1 ~ .,family = binomial, data = df_psa4)

#Summary Statistics
#summary(logit_1)
#summary(logit_2)
#summary(logit_3)
#summary(logit_4)
```

```{r}

df_base <- df_tmp %>% dplyr::select(-c(KHhyp12pB, KHbbmyo12))

trainingRows <- sample(1:nrow(df_base), 0.8 * nrow(df_base))
trainingData <- df_tmp[trainingRows, ]
testData <- df_tmp[-trainingRows, ]
```

```{r, echo=F, eval=F}
df_base_char <- df_base
for (i in colnames(df_base_char)){
  
  col_meta <- df_meta_lvls[df_meta_lvls$Varname == i,]
  
  col_type <- col_meta[1,]$Type
  
  if (i != "GZmehm1"){
     if(nrow(col_meta) > 0){
      # print(paste(i, col_type))
      
      
      if (col_type == "Scale" | col_type == "Ordinal"){
        # print(i)
        df_base_char[[i]] <- as.numeric(as.character(df_base_char[[i]]))
      }else{
        df_base_char[[i]] <- paste0("_", as.character(df_base_char[[i]]))
      }
  
    }else{
      df_base_char[[i]] <- as.numeric((df_base_char[[i]]))
    }
  }
  
}
```

```{r, echo=F, eval=F}
write.csv(df_base, "df_base_numeric.csv", row.names=FALSE)
write.csv(df_base_char, "df_base_char.csv", row.names=FALSE)
```

Causal Analysis: Propensity Score Matching
```{r}
#psm = propensity score matching
psm_model <- glm(IAarzt1B ~ .,family = binomial (link = "probit"), data = df_base)

#Using this model, we can now calculate the propensity score for each person. It is simply the student’s predicted probability of being Treated, given the estimates from the logit model. Below, I calculate this propensity score using predict() and create a dataframe that has the propensity score as well as the student’s actual treatment status.
psm_df <- data.frame(predict_score = predict(psm_model, type = "response"),
                     treated = psm_model$model$IAarzt1B)

```

Examining the region of common support
```{r}
labs <- paste("Visit general practitioner in LTM:", c("NO", "YES"))
psm_df %>%
  mutate(treated = ifelse(treated == 1, labs[1], labs[2])) %>%
  ggplot(aes(x = predict_score)) +
  geom_histogram(color = "white") +
  facet_wrap(~treated) +
  xlab("Propensity Score (Prob. of NOT having visited GP in LTM)") +
  theme_bw()
```

Executing a matching algorithm

Find pairs of observations that have very similar propensity scores, but that differ in their treatment status. matchit package estimates the propensity score then matches observations based on the method of choice (“nearest” in this case).

```{r}

dim(df_base)

set.seed(100)
mod_match <- matchit(IAarzt1B ~ 
                            
                            sex + age5B + MIbirthplace + MIcitizen + bula + PAgroe + PAgewiB + IAkv1D + SDaeqeink_k + SDbild4C + SDbverh2 + SDhvtypD + SDmainstat + SDalo + PAhhtype + ENobstBz1 + ENgemBz1 + AKoft12_k + RCstat + KAehispaq2 + KAehispaq4 + KAspodauC_k + KAehispaq8 + KAgfka + KAgfa + KAgfka1 + KAgfmk + IPinfl4 + IPinfl6B + IPtet_lz + AMarztB + AMfrei + AUarbzD_k + IAhypus + IAcholus + IAdiabus + IAkfutyp2B_lz + IAkfutyp4B_lz + IAtermin + IAweg + IAarzt14B + IAarzt1B4w + IAfa4w + IAarzt8C + IAkhs + IAkhs_k + IAther2B + IApflege + GZmehm3C + GZmehm2D + BBbehB + GZsubj1 + SHseh1 + SHhoer1 + LQsf367C + LQsf368C + flagHadAccident + BBdors112 + BBdors212 + BBblas12B + BBgehen + BBtreppe + BBmyo12 + BBsa12 + KHhyp12 + KHhyp + KHhypmedC + KHmyo12 + KHkhk12 + KHhi12 + KHsa12 + KHdiabB12 + KHab12 + KHkarz12 + KHlip12A + KHlipA + KHlipmedA + KHcb12 + KHulc12 + KHced12 + KHlz12 + KHcle12 + KHniB12 + KHdge12 + KHra12 + KHos12 + KHalgi112 + LQzufrB10 + PKdep12 + SFoslo1C + SFoslo3A + SFosloA + GZmehm1
                            , data = df_base, method = "nearest", replace = FALSE, caliper = 0.2)

```

To create a dataframe containing only the matched observations
```{r}
dta_m <- match.data(mod_match)
dim(dta_m)

```

Examining covariate balance in the matched sample
We’ll check difference in means for a handful of variables to assess covariate balance in the matched sample:

Difference in Means
```{r}
dta_m_numeric <- dta_m #making a new df in order to conver variables to numeric

#Picked 5 variables, including wellbeing to confirm the means were close to each other
dta_m_numeric$sex <- as.numeric(dta_m_numeric$sex)
dta_m_numeric$GZmehm1 <- as.numeric(dta_m_numeric$GZmehm1)
dta_m_numeric$RCstat <- as.numeric(dta_m_numeric$RCstat)
dta_m_numeric$bula <- as.numeric(dta_m_numeric$bula)
dta_m_numeric$PAhhtype <- as.numeric(dta_m_numeric$PAhhtype)


mean_check_var <- c("sex","GZmehm1","RCstat","bula","PAhhtype")

#Checking to see the means are close to each other
dta_m_numeric %>%
  group_by(IAarzt1B) %>% 
  dplyr :: select(one_of(mean_check_var)) %>%
  summarise_all(funs(mean)) %>%
  kable() %>%
  kable_styling()
```

Estimating treatment effects
```{r}

with(dta_m_numeric, t.test(GZmehm1 ~IAarzt1B ))

psm_results <- polr(GZmehm1 ~ 
                      IAarzt1B+ sex + age5B + MIbirthplace + MIcitizen + bula + PAgroe + PAgewiB + IAkv1D + SDaeqeink_k + SDbild4C + SDbverh2 + SDhvtypD + SDmainstat + SDalo+ PAhhtype + AKoft12_k + RCstat + KAehispaq2 + KAspodauC_k + KAehispaq8
                      , data = dta_m)

#Excluded: given the consistent errors received as a result of using the polr function in R and the marginal impact of IAarzt1B on GZmehm1, we excluded the below variables

#GZmehm2D + LQsf367C + BBgehen + BBtreppe + KHhyp + KHhypmedC + KHkhk12 + KHhi12 + KHkarz12 + KHlip12A + KHulc12 + KHced12 + KHos12 + KHalgi112 + LQzufrB10 + PKdep12 + SFoslo1C + SFoslo3A               

#+ KAgfka + KAgfa + KAgfka1 + KAgfmk + IPinfl4 + IPinfl6B + IPtet_lz + AMarztB + AMfrei + AUarbzD_k + IAhypus + IAcholus + IAdiabus + IAkfutyp2B_lz + IAkfutyp4B_lz + IAtermin + IAweg + IAarzt14B + IAarzt8C + IAkhs + IAther2B + IApflege + GZmehm3C + BBbehB+ GZsubj1+ SHseh1 + SHhoer1+ KHlipA + BBmyo12 +BBsa12+KHhyp12 + KHmyo12+KHsa12+ KHdiabB12+ KHab12+ KHlipmedA+ KHcb12+ KHlz12+ KHcle12 + KHniB12+ KHdge12+ KHra12         
summary(psm_results)
```

## Model selection

[Please refer to python flow for model selection.]

## Ordered logistic regression

Model fitting:
```{r, echo=F}
m <- polr(GZmehm1 ~ ., data = trainingData, Hess=TRUE)
summary(m)
```

The goal here would be to create a table that demonstrates the similarities and/or diff in the statistically significant variables we found while subsetting the data

Questions: Should we subset on smoking?

Subsetting: Sex = 1
```{r, echo=F}
trainingData_sex1 <- subset(trainingData,trainingData$sex == 1)
m_sex1 <- polr(GZmehm1 ~ ., data = trainingData_sex1, Hess=TRUE)
summary(m_sex1)

df_model_sum <- as.data.frame(coef(summary(m_sex1)))

## calculate and store p values
df_model_sum$p <- pnorm(abs(df_model_sum$`t value`), lower.tail = FALSE) * 2

df_model_sum$sig_col <- ifelse(df_model_sum$p < 0.001,'***',ifelse(df_model_sum$p < 0.01,'**',
                     ifelse(df_model_sum$p < 0.05,'*',
                            ifelse(df_model_sum$p < 0.1,'.', ''
                     ))))


df_model_sum$logodds <- format(exp(df_model_sum$Value), trim = TRUE, digits = 3, scientific = F)

df_meta_lvls$coeff_label <- paste0(df_meta_lvls$Varname,df_meta_lvls$numLevel)
df_model_sum <- setDT(df_model_sum, keep.rownames = TRUE)[]
df_model_sum <- df_model_sum %>% dplyr::rename(coeff_label = rn)
df_model_sum <- df_model_sum %>% left_join((df_meta_lvls %>% dplyr::select(c(coeff_label, ThemeEn, Varname, VarLabelEn, textLabelEn))), by="coeff_label")

df_model_sum %>% 
  kable() %>%
  kable_styling()
```


```{r}
# stargazer(m, type="html", covariate.labels=c(""), out="models.htm")
```


Evaluating the model and interpreting the coefficients. 
For this:

* p-values are calculated based on the t-values as well as the significance level
* the logodds are calculated by exp({VALUE-OF-THE-COEFFICIENT})
* the coefficients are joint with the meta data to ease interpretation

```{r}

df_model_sum <- as.data.frame(coef(summary(m)))

## calculate and store p values
df_model_sum$p <- pnorm(abs(df_model_sum$`t value`), lower.tail = FALSE) * 2

df_model_sum$sig_col <- ifelse(df_model_sum$p < 0.001,'***',ifelse(df_model_sum$p < 0.01,'**',
                     ifelse(df_model_sum$p < 0.05,'*',
                            ifelse(df_model_sum$p < 0.1,'.', ''
                     ))))


df_model_sum$logodds <- format(exp(df_model_sum$Value), trim = TRUE, digits = 3, scientific = F)

df_meta_lvls$coeff_label <- paste0(df_meta_lvls$Varname,df_meta_lvls$numLevel)
df_model_sum <- setDT(df_model_sum, keep.rownames = TRUE)[]
df_model_sum <- df_model_sum %>% dplyr::rename(coeff_label = rn)
df_model_sum <- df_model_sum %>% left_join((df_meta_lvls %>% dplyr::select(c(coeff_label, ThemeEn, Varname, VarLabelEn, textLabelEn))), by="coeff_label")

df_model_sum %>% 
  kable() %>%
  kable_styling()
```

### Interpretation

According to the ordered logitstic regression, the exponentiated coefficients can be interpreted as the percent-effect (logodds) for the next higher class in the response. In this case the following examples illustrate: 

##### Example 1: bula9 --> Classifies participants from Bavaria
Bula is encoded as the national state with 16 variables.

```{r, echo=F}
describe(df_overall$bula)
```

bula9 coefficient results:

```{r, echo=F}
df_model_sum[df_model_sum$coeff_label=='bula9',] %>% 
  kable() %>%
  kable_styling()
```

Thus, the chances of rating higher on positive wellbeing are 36.2% higher when living in Bavaria as compared to other states. With a low p-value of < 0.001 this is a significant impact driver.

##### Example 1: ENobstBz1 --> Classifies the # of portions of fruit consumed within a week

```{r, echo=F}
describe(df_overall$ENobstBz1)
```

```{r, echo=F}
df_model_sum[df_model_sum$coeff_label=='ENobstBz1',] %>% dplyr::select(-c(ThemeEn, Varname, VarLabelEn)) %>%
  kable() %>%
  kable_styling()
```

Increasing the portion of fruit consumption / week by 1 unit increases the chance of rating happier by 4,1%. This is statistically significant with a low p-value of 0.044.

### Model evaluation of ordered logit:

For model evaluation of the ordered logit, the predictions shall be evaluated on test data (20% of overall data - OOB error). 

#### Confusion matrix
The model performance indicates an overall accuracy of ~68% with reasonable performance throughout all classes except for the rating == 2. It seems that model / particiapnts show no clear distinction between a very bad rating and a bad rating and a bad and mediocre rating as the confusion amongst those combinations is high (-> Sensitivity is very low for these classes).

However, the balanced accuracy overall seems to indicate a reasonable model for estimating the wellbeing score of individuals.

```{r testdata ordered logit, echo=F}
options(scipen=3)
predictedClass <- predict(m, testData) 
confusionMatrix(predictedClass, testData$GZmehm1)
```

```{r, Exec. Summary: Results Table, echo = F}
library(data.table)


df_model_sum_test <- df_model_sum
df_model_sum_test$sig_col[df_model_sum_test$sig_col == ""] <- "not.sig."

sig_table <- table(df_model_sum_test$VarLabelEn, df_model_sum_test$sig_col)
sig_table <- cbind(sig_table, Total = rowSums(sig_table))
sig_table <- as.data.frame.matrix(sig_table)
#convert the row name to a column of the df
#add column name
sig_table <- setDT(sig_table, keep.rownames = TRUE)[]
colnames(sig_table)[1] <- "VarLabelEn"

#create a variable that measures the importance
sig_table$importance <- (sig_table[,7]-sig_table[,6])/sig_table[,7]


## thoughts: create the actionable list of variables as a list in R therefore it is easy to reference and adjust
actionable <- data.frame(VarLabelEn = c(
'state',
'Type of employment',
'Alcohol i.d.l. 12 months in 6 Cat.',
'Smoke',
'Stop. aerobic WHO Bew.empf. (With Go> = 150 min. Aerobic körp. Aktiv./Wo)',
'> = 150 min Ausdaueraktiv.und 2x / week Active. for Muskelkräft. (stop. WHO both Sens.)',
'Stop. aerobic WHO Bew.empf. (O. Go> = 150 aerobic körp. Aktiv./Wo min.)',
'WHO Rec. to Muskelkräft. (> = 2x / wk. Activities. To strengthen the muscles)',
'Frequency flu vaccine generated','Dental examination',
'Visit psychologists i.d.l. 12 Mon.',
'Visit physiotherapists i.d.l. 12 Mon',
'Use of home care services: I.d.l. 12 Mon.',
'Social support (Oslo 3 Social Support Scale)'))

actionable$Actionable <- "Y"

#Join the "Actionable" flag (refer to above df)
sig_table <- left_join(sig_table,actionable)

#Join the Themes associated with the Variable Names
sig_table <- left_join(sig_table,unique(dplyr::select(df_model_sum,VarLabelEn,ThemeEn)))

#subset the list of variables to actionable ones
subset_actionable <- subset(sig_table, Actionable == "Y")
#create a table that orders based on importance & actionable
table_subset_actionable <- subset_actionable[order(-subset_actionable$importance),]

#create a table that orders just based on importance
subset_importance <- subset(sig_table,importance > 0)
table_subset_importance <-subset_importance[order(-subset_importance$importance),]


#Printing of the relevant tables
table_subset_actionable %>% kable() %>% kable_styling()

table_subset_importance %>% kable() %>% kable_styling()

```

```{r Appendix: Subset of table by Theme, echo = FALSE}

#for the appendix of the presentation. Include a table by Theme.
#unique_themes <- unique(sig_table$ThemeEn)

#for (i in unique_themes){
  
  #theme_subset <- subset(sig_table, ThemeEn == i)
  #table <- theme_subset[order(-theme_subset$importance),]
  #kable(table) %>% kable_styling()
  
#}

#Diseases
theme_diseases <- subset(sig_table, ThemeEn == "Diseases (1101)")
theme_diseases[order(-theme_diseases$importance),] %>% kable() %>% kable_styling()

#Age and Gender
theme_age_gender <- subset(sig_table, ThemeEn == "Age and gender (1701)")
theme_age_gender[order(-theme_age_gender$importance),] %>% kable() %>% kable_styling()

#physical activity
theme_phy_act <- subset(sig_table, ThemeEn == "Physical Activity (1501)")
theme_phy_act[order(-theme_phy_act$importance),] %>% kable() %>% kable_styling()

#Alcohol
theme_alcohol <- subset(sig_table, ThemeEn == "Alcohol (1504)")
theme_alcohol[order(-theme_alcohol$importance),] %>% kable() %>% kable_styling()

#Sociodemographic
theme_sociodem <- subset(sig_table, ThemeEn == "Sociodemography (1704)")
theme_sociodem[order(-theme_sociodem$importance),] %>% kable() %>% kable_styling()

#Health
theme_health <- subset(sig_table, ThemeEn == "Health (1102)")
theme_health[order(-theme_health$importance),] %>% kable() %>% kable_styling()

#Disability
theme_disability <- subset(sig_table, ThemeEn == "Func. Beeinträcht, and complaints. Disability (1105)")
theme_disability[order(-theme_disability$importance),] %>% kable() %>% kable_styling()

#Migration Status
theme_migration <- subset(sig_table, ThemeEn == "Migration Status (1705)")
theme_migration[order(-theme_migration$importance),] %>% kable() %>% kable_styling()

#Use
theme_use <- subset(sig_table, ThemeEn == "Use (1401)")
theme_use[order(-theme_use$importance),] %>% kable() %>% kable_styling()

#Mental
theme_mental <- subset(sig_table, ThemeEn == "Mental Krankh./Auffälligkeiten (1301)")
theme_mental[order(-theme_mental$importance),] %>% kable() %>% kable_styling()

#QoL
theme_qol <- subset(sig_table, ThemeEn == "Quality of Life (1109)")
theme_qol[order(-theme_qol$importance),] %>% kable() %>% kable_styling()

#Vaccine
theme_vacc <- subset(sig_table, ThemeEn == "Vaccinations (1402)")
theme_vacc[order(-theme_vacc$importance),] %>% kable() %>% kable_styling()

#protection factors
theme_protection <- subset(sig_table, ThemeEn == "Protection factors (1303)")
theme_protection[order(-theme_protection$importance),] %>% kable() %>% kable_styling()

#See and Hear
theme_see_hear <- subset(sig_table, ThemeEn == "Seeing and hearing (1104)")
theme_see_hear[order(-theme_see_hear$importance),] %>% kable() %>% kable_styling()

#personal data
theme_personaldata <- subset(sig_table, ThemeEn == "Personal data (1702)")
theme_personaldata[order(-theme_personaldata$importance),] %>% kable() %>% kable_styling()

#smoking
theme_smoking <- subset(sig_table, ThemeEn == "Smoking (1505)")
theme_smoking[order(-theme_smoking$importance),] %>% kable() %>% kable_styling()

#strain
theme_strain <- subset(sig_table, ThemeEn == "Strain (1801)")
theme_strain[order(-theme_strain$importance),] %>% kable() %>% kable_styling()

#Medicines
theme_medicines <- subset(sig_table, ThemeEn == "Medicines (1403)")
theme_medicines[order(-theme_medicines$importance),] %>% kable() %>% kable_styling()

```

```{r, eval=FALSE, echo=FALSE}

# Evaluatinon of different methods:


## Multinomial model 
#source: https://data.library.virginia.edu/fitting-and-interpreting-a-proportional-odds-model/

# @TODO: Compare different models types 

#trainingRows <- sample(1:nrow(df_tmp), 0.8 * nrow(df_tmp))
#trainingData <- df_tmp[trainingRows, ]
#testData <- df_tmp[-trainingRows, ]



mlm <- nnet(GZmehm1 ~ ., data = trainingData,family="multinomial",size = 5574900,MaxNWts =10000000)



# mlm <- multinom(GZmehm1 ~ ., data = trainingData)

M1 <- logLik(m)
M2 <- logLik(mlm)
(G <- -2*(M1[1] - M2[1]))


# run chi-squared test
# hint: https://rpubs.com/mpfoley73/460935 

# @Interpret Chi-squared P-value -> high = the fit of both models is different from one another.


pchisq(G,3,lower.tail = FALSE)
```

## Create meta data for the chatbot

```{r}
Varname = colnames(df_base)
df_relevant_cols <- as.data.frame(Varname)
df_bot_cols <- df_relevant_cols %>% dplyr::left_join(df_meta_lvls) %>% dplyr::select(-SortOrder)
write.csv(df_bot_cols, "df_bot_cols.csv", row.names=FALSE)
df_bot_cols
```


