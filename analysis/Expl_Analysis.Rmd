---
title: "WellbeingAnalytics"
author: "Uli Kaulfuß"
date: "2 November 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(foreign)
library(readstata13)
library(dplyr)
library(naniar)

require(ggplot2)
require(MASS)
require(Hmisc)
require(reshape2)

library(cluster)

library(VIM)

set.seed(42)

```

# Wellbeing Analytics

### Preparing


```{r data loading}

suppressWarnings({
  DE_data <- read.dta13("data/GEDA14.dta")
  EN_data <- read.dta13("data/translated.data.set.dta")
  
  DE_data$RowID <- seq.int(nrow(DE_data))
  EN_data$RowID <- seq.int(nrow(EN_data))
  
  save(EN_data, file = "data/translated.data.set.RData")
})

head(EN_data)
```



```{r}

df_base <- DE_data %>% dplyr::select(
 KHhyp12, # Bluthochdruck: I.d.l.12 Mon.
KHhyp, # Bluthochdruck: Jemals ärztlich diagnostiziert
KHhyp12pB, # Indikator bek. (ärztl. diagn.) Bluthochdruckdruck i.d.l. 12 Mon
KHhypmedC, # Indikator blutdrucksenkende Mittel bei bekannter Hypertonie
KHmyo12, # Herzinfarkt: I.d.l. 12 Mon.
KHkhk12, # Koronare Herzerkrankung/Angina Pectoris: I.d.l.12 Mon.
KHbbmyo12,# Herzinfarkt/chron. Beschw.: I.d.l. 12 Mon.
KHhi12, # Herzinsuffizienz: I.d.l.12 Mon.
KHsa12, # Schlaganfall: I.d.l.12 Mon.
KHbbsa12, # Schlaganfall/ chron. Beschwerden infolge SA: I.d.l.12 Mon.
KHdiabB12, # Diabetes: I.d.l.12 Mon.
KHab12, # Asthma: I.d.l.12 Mon.
KHkarz12, # Krebserkrankung: I.d.l.12 Mon.
KHlip12A, # Erhöhte Blutfette/Chol.: I.d.l.12 Mon.
KHlipA, # Jemals erhöhte Blutfette/Cholesterinw. (Arztdiagnose)
KHlipmedA, # Erhöhtes Cholesterin: Zurzeit Medikamenteneinnahme
KHcb12,# Chronische Bronchitis: I.d.l.12 Mon.
KHulc12,# Magen- oder Zwölffingerdarmgeschwür: I.d.l.12 Mon.
KHced12,# Chronisch entzündliche Darmerkrankung: I.d.l.12 Mon.
KHlz12,# Leberzirrhose: I.d.l.12 Mon.
KHcle12,# Andere chronische Lebererkrankungen: I.d.l.12 Mon.
KHniB12,# Chron. Nierenprobleme: I.d.l.12 Mon.
KHdge12,# Arthrose: I.d.l.12 Mon.
KHra12,# Arthritis: I.d.l.12 Mon.
KHos12,# Osteoporose: I.d.l.12 Mon.
KHalgi112,# Allergien: I.d.l. 12 Mon.
GZmehm1,# Allg. Gesundheitszustand
GZmehm3C,# Chronische Krankheiten
GZmehm2D,# Einschränkung durch Krankheit seit mind. 6 Monaten
GZsubj1,# Achten auf Gesundheit
SHseh1,# Brille oder Kontaktlinsen
SHhoer1,# Hörgerät
BBmyo12,# Chronische Beschwerden nach Herzinfarkt: I.d.l.12 Mon.
BBsa12,# Chronische Beschw. infolge eines Schlaganfalls: I.d.l.12 Mon.
BBdors112,# Beschwerden unterer Rücken: I.d.l.12 Mon.
BBdors212,# Beschwerden Nacken, Halswirbelsäule: I.d.l.12 Mon.
BBblas12B,# Harninkontinenz: I.d.l.12 Mon.
BBschwierig1,# Schwierigk. bei Ausführen o. Hilfe: Essen oder Trinken
BBschwierig2,# Schwierigk. bei Ausführen o. Hilfe: v. Bett/Stuhl erheben od. niederlassen
BBschwierig3,# Schwierigk. bei Ausführen o. Hilfe: An- und Ausziehen
BBschwierig4,# Schwierigk. bei Ausführen o. Hilfe: Toilettenbenutzung
BBschwierig5,# Schwierigk. bei Ausführen o. Hilfe: Baden oder Duschen
BBhh1,# Schwierigk. Ausführen o. Hilfe: Mahlzeiten zubereiten
BBhh2,# Schwierigk. Ausführen o. Hilfe: Das Telefon benutzen
BBhh3,# Schwierigk. Ausführen o. Hilfe: Einkäufe erledigen
BBhh4,# Schwierigk. Ausführen o. Hilfe: Medikamenteneinn. org.
BBhh5,# Schwierigk. Ausführen o. Hilfe: Leichte Hausarbeit erledig.
BBhh6,# Schwierigk. Ausführen o. Hilfe: Gelegentlich schwere Hausarbeit erled.
BBhh7,# Schwierigk. Ausführen o. Hilfe: Org. fin. und alltägl. Verwaltungsangeleg.
BBbehB,# Amtlich anerkannte Behinderung 
UVartverkehr,# Verletzung wg. Unfall i.d.l. 12 Monaten: Verkehrsunfall
UVarthaus,# Verletzung wg. Unfall i.d.l. 12 Monaten: Unfall zu Hause
UVartfreiz,# Verletzung wg. Unfall i.d.l. 12 Monaten: Unfall in der Freizeit
UVarbeit1,# Verletzung Arbeitsunfall: I.d.l. 12 Mon. (kein Wegeunfall)
SEschwA_zz,# Schwanger zur Zeit
LQsf367C,# Stärke Schmerzen i.d.l. 4 Wochen
LQsf368C,# Behinderung in Alltagstätigkeiten durch Schmerzen i.d.l. 4 Wochen
LQzufrB10,# Zufriedenheit: Leben insgesamt
PKdep12,# Depression: I.d.l. 12 Mon.
PKphq1,# Beeintr. i.d.l. 2 Wo.: Wenig Interesse/Freude an Ihren Tätigkeiten
PKphq2,# Beeintr. i.d.l. 2 Wo.: Niedergeschlagenheit, Schwermut/Hoffnungslosigkeit
PKphq3,# Beeintr. i.d.l. 2 Wo.: Schwierigk., ein-/durchzuschlafen od. vermehrter Schlaf
PKphq4,# Beeintr. i.d.l. 2 Wo.: Müdigkeit/Gefühl, k. Energie zu haben
PKphq5,# Beeintr. i.d.l. 2 Wo.: Vermind. Appetit/übermäßiges Bedürfnis zu essen
PKphq6,# Beeintr. i.d.l. 2 Wo.: Schlechte Meinung v. sich; Versagen/Familie zu entt.
PKphq7,# Beeintr. i.d.l. 2 Wo.: Schwierigk., sich zu konzentrieren
PKphq8,# Beeintr. i.d.l. 2 Wo.: Veränderung in Bewegung oder Sprache
SFoslo1C,# Nahestehende Personen
SFoslo2C,# Anteilnahme anderer Personen
SFoslo3A,# Erhalt von Hilfe
SFosloA,# Soziale Unterstützung (Oslo-3 Social Support Scale)
IAhypus,# Letzte Blutdruckmessung
IAcholus,# Letzte Blutfettwertebestimmung
IAdiabus,# Letzte Blutzuckermessung
IAtermin,# Auf Untersuchungstermin gewartet i.d.l. 12 Mon.
IAweg,# Untersuchung verzögert wegen Entfernung i.d.l. 12 Mon.
IAarzt8C,# Besuch Psychologen i.d.l. 12 Mon.
IAkhs,# Stationär im Krankenhaus i.d.l. 12 Mon.
IAkhs_k,# Stationär im Krankenhaus i.d.l. 12 Mon.: Anzahl der Nächte (kat)
IAambC,# Tagespatient im Krankenhaus i.d.l. 12 Mon.
IAambC_k,# Tagespatient im Krankenhaus i.d.l. 12 Mon.: Anzahl der Aufnahmen (top coding 10 oder mehr)
IAther2B,# Besuch Physiotherapeuten i.d.l. 12 Mon
IApflege,# Inanspruchnahme häuslicher Pflegedienst: I.d.l. 12 Mon.
IAkfutyp2B_lz,# Letzter Stuhltest
IAkfutyp4B_lz,# Letzte Darmspiegelung
IAkfutyp7B_lz,# Letzte Mammografie
IAkfutyp5B_lz,# Letzter Gebärmutterhalsabstrich
IAkv1D,# Krankenversicherung in 3 Kat.
IPinfl4,# Letzte Grippeimpfung
IPinfl4_mm,# Letzte Grippeimpfung: Monat
IPinfl4_jj,# Letzte Grippeimpfung: Jahr
IPtet,# Jemals Tetanusimpfung
AMarztB,# Einnahme Medikamente v. Arzt verschrieben i.d.l. 2 Wo
AMfrei,# Einnahme Medikamente nicht v. Arzt verschrieben i.d.l. 2 Wo
AUarbzD_k,# Krankheitsbedingt nicht zur Arbeit: Wochen
KAehispaq1,# Tätigkeiten (Anstrengung)
KAehispaq2,# Bewegung zu Fuß: Tage pro Woche
KAehispaq4,# Bewegung mit Fahrrad: Tage pro Woche
KAehispaq6,# Sport: Tage pro Woche
KAehispaq8,# Aufbau/Kräftigung: Tage pro Woche
KAabka,# Mäßig bis sehr anstrengende arbeitsbez. körp. Aktivität
KAsabka,# Sehr anstrengende arbeitsbezogene körperliche Aktivität
KAtbka_k,# Transportbez. körp. Aktivität in MET/Stunden/Woche (top coding ab 100h)
KAgfka,# Einhalt. aerobe WHO-Bew.empf. (mit Gehen >= 150 Min. aerobe körp. Aktiv./Wo)
KAgfa,# >= 150 min Ausdaueraktiv.und 2 x/ Woche Aktiv. zur Muskelkräft.(Einhalt. beider WHO-Empf.)
KAgfka1,# Einhalt. aerobe WHO-Bew.empf. (o. Gehen >= 150 Min. aerobe körp. Aktiv./Wo)
KAgfmk,# WHO-Empf. zur Muskelkräft. (>= 2x/Wo. Aktivit. zur Muskelkräftigung)
KAgka,# Ausreichend körp. aktiv während Arbeit oder Freizeit
KAgka_k,# Gesamtaktivität
ENobstB,# Verzehr von Obst
ENgemB,# Verzehr von Gemüse
AKoft12_k,# Alkohol i.d.l. 12 Mon. in 6 Kat.
AKechi47,# Gefährlicher Alkoholkonsum (ECHI 47; > 20/40 g/Tag)
AKbingeC_k3,# Mind. 1 Mal pro Monat Rauschtrinken
AKrisiko,# Riskanter Alkoholkonsum (>10/20 g/Tag)
RCstat_k2,# Rauchstatus in 3 Kat.
RCpass4,# Rauchen in geschlossenen Räumen
GVasku1,# Verlass auf eig. Fähigkeiten in schwier. Situationen
GVasku2,# Aus eigener Kraft Probleme gut meistern
GVasku3,# I.d.R. anstr. und komplizierte Aufgaben gut lösen
BLpflege2C,# Unterstützung/Pflege anderer Personen
sex,# Geschlecht
age5B,# Alter (5-Jahres-Gruppen)
PAfam1C,# Familienstand
PAfam3,# Zusammenleben in Ehe oder eheähnlicher Gemeinschaft
PAhh_k,# Anzahl Personen im Haushalt (kat.)
PAmarstadefacto,# Zusammenleben in eheähnlicher Gemeinschaft
PAhhnbpersk_0_4,# Anzahl Personen im Haushalt: 0 bis 4 Jahre (top coding 3 oder mehr)
PAhhnbpersk_5_13,# Anzahl Personen im Haushalt: 5 bis 13 Jahre (top coding 3 oder mehr)
PAhhnbpersk_14_15,# Anzahl Personen im Haushalt: 14 bis 15 Jahre (top coding 3 oder mehr)
PAhhnbpersk_16_24,# Anzahl Personen im Haushalt: 16 bis 24 Jahre (top coding 3 oder mehr)
PAhhnbpersk_25_64,# Anzahl Personen im Haushalt: 25 bis 64 Jahre (top coding 3 oder mehr)
PAhhnbpersk_65PLUS,# Anzahl Personen im Haushalt: 65 Jahre und älter (top coding 3 oder mehr)
PAhhtype,# Haushaltstyp
PAhh_act,# Anzahl der Pers. im HH: 16-64 J. und erwerbstätig
PAhh_inact,# Anzahl der Pers. im HH: 16-64 J. und nicht erwerbstätig
PAgroe,# Körpergröße (Selbstangabe) [cm]
PAgewiB,# Körpergewicht (Selbstangabe) [kg]
PAbmiB_k,# BMI-Gruppierung (aus Selbstangabe)
SDaeqeink_k,# Äquivalenzeinkommen (imputiert,kat) [€]
SDses_bild,# SES-Subscore: Bildung/Ausbildung
SDses_ber,# SES-Subscore: Berufl. Stellung
SDses_eink,# SES-Subscore: Einkommen
SDses_score,# SES: Gesamtscore
SDses_q5,# Quintile des SES-Scores
SDses,# Sozioökonomischer Status (SES)
SDhhincomez,# Monatl. HH-Nettoeinkommen in Quintilen (imputiert)
SDisced11,# ISCED (2011) - Bildungsgruppen
SDhvtypD,# Hauptverdiener im Haushalt
SDerwt0a,# Lebenssituation derzeit
SDmainstat,# Erwerbstätigkeit (EHIS)
SDalo,# Arbeitslos i.d.l. 5 Jahren
MIbirthplace,# Geburtsland (EHIS)
MIcitizen,# Staatsangehörigkeit
untm,# Untersuchungsmonat
untj,# Untersuchungsjahr
ppoint,# Pseudo Sample Point
ktyp4,# Siedlungsstruktureller Kreistyp (BBSR)
bula,# Bundesland
wob# West/Ost/Berlin


)

# df_base$GZmehm1 <- factor(df_base$GZmehm1 , levels = c("Very bad", "bad", "Mediocre", "good", "Very good"))

# df_base %>% naniar::replace_with_na_all(condition = ~.x == 'NA')

sapply(df_base, class)

summary(df_base)

```

```{r}


mice_plot <- aggr(df_base, col=c('navyblue','yellow'),
                    numbers=TRUE, sortVars=TRUE,
                    labels=names(df_base), cex.axis=.7,
                    gap=3, ylab=c("Missing data","Pattern"))
```

Based on the missing values, a low of fields are still containing many NAs due to the fact that they are being asked only to people > 65yrs of age.

```{r}

df_analysis <- df_base %>% dplyr::select(
  -c(
    BBhh5, 
    BBhh6, 
    IPinfl4_mm,
    IPinfl4_jj,
    SEschwA_zz,
    IAkfutyp5B_lz,
    IAkfutyp7B_lz,
    AUarbzD_k,
    
    BBschwierig4,
    BBschwierig1,
    BBschwierig2,		
    BBschwierig3,			
    BBschwierig5,		
    BBhh4,	
    BBhh7,		
    BBhh1,			
    BBhh2,			
    BBhh3
  )
)

df_analysis <- na.omit(df_analysis)

df_analysis <-  df_analysis[complete.cases(df_analysis),]

View(df_analysis)


# df_analysis <-  df_analysis %>% naniar::replace_with_na_all(condition = ~.x == 'NA')

```


```{r}

mice_plot_analysis <- aggr(df_analysis, col=c('navyblue','yellow'),
                    numbers=TRUE, sortVars=TRUE,
                    labels=names(df_analysis), cex.axis=.7,
                    gap=3, ylab=c("Missing data","Pattern"))
```

```{r}
summary(df_analysis)

```

drop unused levels
```{r}

df_analysis <- df_analysis %>% droplevels

fac <- sapply(df_analysis, levels)

bool_fac <- fac[lapply(fac, length) == 2]

df_analysis$GZmehm1 <- factor(df_analysis$GZmehm1, c("Sehr schlecht",  "Schlecht", "Mittelmäßig","Gut", "Sehr gut"))


summary(df_analysis)
```


## Run a basic ordered logit model 

One of the assumptions underlying ordinal logistic (and ordinal probit) regression is that the relationship between each pair of outcome groups is the same. In other words, ordinal logistic regression assumes that the coefficients that describe the relationship between, say, the lowest versus all higher categories of the response variable are the same as those that describe the relationship between the next lowest category and all higher categories, etc. This is called the proportional odds assumption or the parallel regression assumption. Because the relationship between all pairs of groups is the same, there is only one set of coefficients.

Souce: https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/

```{r}

df_test <- df_base %>% dplyr::select(GZmehm1, KHhyp)

# encode factors as numeric

df_test$KHhyp <- as.character(df_test$KHhyp)

df_test[!is.na(df_test$KHhyp) & df_test$KHhyp == 'Ja',]$KHhyp <- '1'
df_test[!is.na(df_test$KHhyp) & df_test$KHhyp == 'Nein',]$KHhyp <- '0'

df_test$KHhyp <- as.numeric(df_test$KHhyp)

df_test <- na.omit(df_test)

m <- polr(GZmehm1 ~ KHhyp, data = df_test, Hess=TRUE)

## view a summary of the model
summary(m)


```


```{r calculating p-values}

(ctable <- coef(summary(m)))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))

# (ci <- confint(m))
```

```{r Odds Ratios}
exp(coef(m))
```

As of now, the interpretation would be: 
For people that have higher blood pressure, the odds of feeling healthier are 75% lower compared to the people that do not have high BP. 

```{r}
sf <- function(y) {
  c('Y>=1' = qlogis(mean(y >= 1)),
    'Y>=2' = qlogis(mean(y >= 2)),
    'Y>=3' = qlogis(mean(y >= 3)),
    'Y>=4' = qlogis(mean(y >= 4)),
    'Y>=5' = qlogis(mean(y >= 5))
    )
}

(s <- with(df_test, summary(as.numeric(GZmehm1) ~ KHhyp, fun=sf)))
```

```{r}
glm(I(as.numeric(GZmehm1) >= 3) ~ KHhyp, family="binomial", data = df_test)
```

```{r}
glm(I(as.numeric(GZmehm1) >= 4) ~ KHhyp, family="binomial", data = df_test)
```

```{r}
plot(s, which=1:5, pch=1:5, xlab='logit', main=' ', xlim=range(s[,4:5]))
```


This graph indicates that for high blood pressure, the parallel slopes assumption does not hold for KHhyp
@Todo: Question: What is the resulting question? Can we still use this method / interpretation? 


## Model with only YES/NO question as first level of analysis

```{r}

m_b <- polr(GZmehm1 ~ KHhyp12+KHhyp+KHhyp12pB+KHhypmedC+KHmyo12+KHkhk12+KHbbmyo12+KHhi12+KHsa12+KHbbsa12+KHdiabB12+KHab12+KHkarz12+KHlip12A+KHlipA+KHlipmedA+KHcb12+KHulc12+KHced12+KHlz12+KHcle12+KHniB12+KHdge12+KHra12+KHos12+KHalgi112+GZmehm3C+BBmyo12+BBsa12+BBdors112+BBdors212+BBblas12B+BBbehB+UVartverkehr+UVarthaus+UVartfreiz+UVarbeit1+PKdep12+IAarzt8C+IAkhs+IAambC+IAther2B+IApflege+IPtet+AMarztB+AMfrei+KAabka+KAsabka+KAgfka+KAgfa+KAgfka1+KAgfmk+KAgka+AKbingeC_k3+BLpflege2C+sex+PAfam3+PAmarstadefacto+SDalo, data = df_analysis, Hess=TRUE)

## view a summary of the model
summary(m_b)
```


```{r calculating p-values basic model}

(ctable <- coef(summary(m_b)))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))

# (ci <- confint(m))
```


```{r}
factorlist <- exp(coef(m_b))
factorlist
```


