---
title: "WellbeingAnalytics"
author: "Capstone Group Wellbeing"
date: "13 Dec 2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(foreign)
library(readstata13)
library(dplyr)
library(naniar)

require(ggplot2)
require(MASS)
require(Hmisc)
require(reshape2)

library(cluster)

library(VIM)

library(knitr)
library(kableExtra)


set.seed(42)

```

# Wellbeing Analytics

The following document should serve as a preparation for the meeting on 15th Dec to illuminate on. Please use the following list as links to jump around in the document.

* [Objective](#object)
* [Data foundation](#data)
* [Data preparation](#dataprep)
* [Data analysis](#analysis)
* [Questions](#questions)

## Objective {#object} 

The purpose of this analysis is to understand and quantify the different drivers that contribute to good wellbeing (good / very good = GZmehm1) in order to give individual advice to improve peoples' lives.

## Data foundation {#data}

The following dataset depicts a subset of the data foundation of the analysis. It is a result of a large, representative survey in Germany with regards to health and wellbeing of the population.


```{r data loading}

suppressWarnings({
  DE_data <- read.dta13("data/GEDA14.dta")
  EN_data <- read.dta13("data/translated.data.set.dta")
  
  DE_data$RowID <- seq.int(nrow(DE_data))
  EN_data$RowID <- seq.int(nrow(EN_data))
  
  save(EN_data, file = "data/translated.data.set.RData")
})

```





```{r}
head(EN_data) %>%
  dplyr::select(c(GZmehm1, sex, age5B, ktyp4, bula)) %>%
  kable() %>%
  kable_styling()

```

In total, the data has `r dim(EN_data)[1]` observations and `r dim(EN_data)[2]` variables inall together. Details can be found in the data dictionary. 

Our target variable is "GZmehm1" which is a categorical self-rating of an individuals' wellbeing between very bad and very good (likert).

The purpose of this analysis is to understand and quantify the different drivers that contribute to good wellbeing (good / very good = GZmehm1).

For this, we have created a pre-selection of variables as some of the variables are essentially the same information, yet differently grouped - e.g. there are several fields for age, which is binned in different sizes, so we are taking into account only one of them (the most granular one).

Hence, we are subsetting the dataset to the following variables: 

```{r}

df_base <- DE_data %>% dplyr::select(
  KHhyp12, # Hypertension: I.d.l.12 Mon.
  KHhyp, # Hypertension: Ever diagnosed by a doctor
  KHhyp12pB, # Indicator bek. (medical diagnosis) Hypertension i.d.l. 12 Mon
  KHhypmedC, # Indicator antihypertensive agent for known hypertension
  KHmyo12, # heart attack: I.d.l. 12 Mon.
  KHkhk12, # coronary heart disease / angina pectoris: I.d.l.12 Mon.
  KHbbmyo12,# Heart attack/chron. Summoning: I.d.l. 12 Mon.
  KHhi12, # heart failure: I.d.l.12 Mon.
  KHsa12, # Stroke: I.d.l.12 Mon.
  KHbbsa12, # stroke/ chronic. Complaints as a result of SA: I.d.l.12 Mon.
  KHdiabB12, # Diabetes: I.d.l.12 Mon.
  KHab12, # Asthma: I.d.l.12 Mon.
  KHkarz12, # cancer: I.d.l.12 Mon.
  KHlip12A, # elevated blood lipids/chol.: I.d.l.12 Mon.
  KHlipA, # Ever Increased Blood Lipids/Cholesterinw. (doctor's diagnosis)
  KHlipmedA, # Elevated Cholesterol: Currently taking medication
  KHcb12,# Chronic bronchitis: I.d.l.12 Mon.
  KHulc12,# Gastric or duodenal ulcer: I.d.l.12 Mon.
  KHced12,# Chronic inflammatory bowel disease: I.d.l.12 Mon.
  KHlz12,# Liver cirrhosis: I.d.l.12 Mon.
  KHcle12,# Other chronic liver diseases: I.d.l.12 Mon.
  KHniB12,# Chron. Kidney problems: I.d.l.12 Mon.
  KHdge12,# Osteoarthritis: I.d.l.12 Mon.
  KHra12,# Arthritis: I.d.l.12 Mon.
  KHos12,# Osteoporosis: I.d.l.12 Mon.
  KHalgi112,# Allergies: I.d.l. 12 Mon.
  GZmehm1,# General state of health
  GZmehm3C,# Chronic diseases
  GZmehm2D,# Restriction due to illness for at least 6 months
  GZsubj1,# Pay attention to health
  SHseh1,# glasses or contact lenses
  SHhoer1,# hearing aid
  BBmyo12,# Chronic symptoms after heart attack: I.d.l.12 Mon.
  BBsa12,# Chronic symptoms following a stroke: I.d.l.12 Mon.
  BBdors112,# Lower back complaints: I.d.l.12 Mon.
  BBdors212,# Complaints neck, cervical spine: I.d.l.12 Mon.
  BBblas12B,# Urinary incontinence: I.d.l.12 Mon.
  BBschwierig1,# Difficult to perform without help: eating or drinking
  BBschwierig2,# Difficult to perform or help: raise from bed/chair or lower
  BBschwierig3,# Difficult to perform without help: Put on and take off
  BBschwierig4,# Difficult to execute or help: use of toilets
  BBschwierig5,# Difficult to perform or help: bath or shower
  BBhh1,# Difficult. Execute without help: Preparing meals
  BBhh2,# Difficult. Execute without help: Using the phone
  BBhh3,# Difficult. Execute without help: Do the shopping
  BBhh4,# Difficult. Execute without help: Medicationin. org.
  BBhh5,# Difficult. Execute without help: Easy housework done.
  BBhh6,# Difficult. Execute without help: Occasionally do heavy housework.
  BBhh7,# Difficult. Execute without help: Org. fin. and everyday administrative matter.
  BBbehB,# Officially recognized disability 
  UVartverkehr,# injury due to accident i.d.l. 12 months: Traffic accident
  UVarthaus,# injury due to accident i.d.l. 12 months: Accident at home
  UVartfreiz,# injury due to accident i.d.l. 12 months: Accident during leisure time
  UVarbeit1,# Injury Occupational accident: I.d.l. 12 Mon. (no commuting accident)
  SEschwA_zz,# Pregnant at the moment
  LQsf367C,# strength pain i.d.l. 4 weeks
  LQsf368C,# Disability in everyday activities due to pain i.d.l. 4 weeks
  LQzufrB10,# Satisfaction: Life total
  PKdep12,# Depression: I.d.l. 12 Mon.
  PKphq1,# Impairment i.d.l. 2 Wo.: Little interest / joy in your activities
  PKphq2,# Impairment i.d.l. 2 Wo.: depression, melancholy/hopelessness
  PKphq3,# Impairment i.d.l. 2 Wo.: Difficult to fall asleep/ sleep through or increased sleep
  PKphq4,# Impairment i.d.l. 2 Wo.: Tiredness/feeling to have k. energy
  PKphq5,# Impairment i.d.l. 2 Wo.: Reduced appetite / excessive need to eat
  PKphq6,# Impact i.d.l. 2 Wo.: Bad opinion of oneself; Failure/Family to depart.
  PKphq7,# Impaired i.d.l. 2 Wo.: Difficult to concentrate
  PKphq8,# Impairment i.d.l. 2 Wo.: Change in movement or language
  SFoslo1C,# Related parties
  SFoslo2C,# Participation of other persons
  SFoslo3A,# Getting help
  SFosloA,# Social Support (Oslo-3 Social Support Scale)
  IAhypus,# Last blood pressure measurement
  IAcholus,# Last determination of blood lipid values
  IAdiabus,# Last blood glucose test
  IAtermin,# Waiting for examination i.d.l. 12 Mon.
  IAweg,# examination delayed due to removal i.d.l. 12 Mon.
  IAarzt8C,# visit psychologist i.d.l. 12 Mon.
  IAkhs,# Inpatient in hospital i.d.l. 12 Mon.
  IAkhs_k,# Inpatient in hospital i.d.l. 12 Mon.: Number of nights (kat)
  IAambC,# Day patient in hospital i.d.l. 12 Mon.
  IAambC_k,# day patient in hospital i.d.l. 12 months: number of admissions (top coding 10 or more)
  IAther2B,# Visit physiotherapists i.d.l. 12 Mon
  IApflege,# use of home care services: I.d.l. 12 Mon.
  IAkfutyp2B_lz,# Last stool test
  IAkfutyp4B_lz,# Last colonoscopy
  IAkfutyp7B_lz,# Last mammography
  IAkfutyp5B_lz,# Last cervical smear
  IAkv1D,# Health insurance in 3 Cat.
  IPinfl4,# Last flu vaccination
  IPinfl4_mm,# Last flu vaccination: month
  IPinfl4_jj,# Last flu vaccination: year
  IPtet,# Ever had a tetanus shot.
  AMarztB,# Taking medications prescribed by a doctor i.d.l. 2 Wo
  AMfrei,# Taking medication not prescribed by a doctor i.d.l. 2 Wo
  AUarbzD_k,# Not to work due to illness: weeks
  KAehispaq1,# Activities (effort)
  KAehispaq2,# Foot movement: days per week
  KAehispaq4,# exercise by bike: days per week
  KAehispaq6,# Sports: Days per week
  KAehispaq8,# Construction/strengthening: Days per week
  KAabka,# Moderate to very strenuous body work. Activity
  KAsabka,# Very strenuous work-related physical activity
  KAtbka_k,# Transport reference body. Activity in MET/hours/week (top coding from 100h)
  KAgfka,# halt aerobic WHO-Bew.empf. (with walking >= 150 min. aerobic body active./week)
  KAgfa,# >= 150 min endurance active.and 2 x/ week active. for muscle strength. (stop. of both WHO-recept.)
  KAgfka1,# stop aerobic WHO-Bew.empf. (no walking >= 150 min. aerobic body active/week)
  KAgfmk,# WHO-receptor for muscle strength. (>= 2x/week activity for muscle strengthening)
  KAgka,# Sufficiently active body during work or leisure time
  KAgka_k,# Total activity
  ENobstB,# Consumption of fruit
  ENgemB,# Consumption of vegetables
  AKoft12_k,# Alcohol i.d.l. 12 Mon. in 6 Cat.
  AKechi47,# Dangerous alcohol consumption (ECHI 47; > 20/40 g/day)
  AKbingeC_k3,# Drink at least 1 time per month
  AKrisiko,# Risky alcohol consumption (>10/20 g/day)
  RCstat_k2,# Smoke status in 3 Cat.
  RCpass4,# Smoking in closed rooms
  GVasku1,# Rely on own abilities in difficult. Situations
  GVasku2,# Mastering problems well under your own steam
  GVasku3,# I.d.R. anstr. and solve complicated tasks well
  BLpflege2C,# Support/care of other persons
  sex,# sex
  age5B,# Age (5-year groups)
  PAfam1C,# Marital status
  PAfam3,# Living together in marriage or marriage-like community
  PAhh_k,# Number of persons in household (cat.)
  PAmarstadefacto,# Living together in a marriage-like community
  PAhhnbpersk_0_4,# Number of persons in household: 0 to 4 years (top coding 3 or more)
  PAhhnbpersk_5_13,# Number of persons in household: 5 to 13 years (top coding 3 or more)
  PAhhnbpersk_14_15,# Number of persons in household: 14 to 15 years (top coding 3 or more)
  PAhhnbpersk_16_24,# Number of persons in household: 16 to 24 years (top coding 3 or more)
  PAhhnbpersk_25_64,# Number of persons in household: 25 to 64 years (top coding 3 or more)
  PAhhnbpersk_65PLUS,# Number of persons in household: 65 years and over (top coding 3 or more)
  PAhhtype,# Household type
  PAhh_act,# Number of persons in HH: 16-64 y.o. and employed
  PAhh_inact,# Number of persons in HH: 16-64 years and not employed
  PAgroe,# body height (self-declaration) [cm]
  PAgewiB,# Body weight (self-declaration) [kg]
  PAbmiB_k,# BMI grouping (from self-declaration)
  SDaeqeink_k,# Equivalent income (imputed,cat) [€]
  SDses_bild,# SES subscore: Education/training
  SDses_ber,# SES subscore: Professional position
  SDses_eink,# SES subscore: Income
  SDses_score,# SES: Total score
  SDses_q5,# Quintiles of the SES score
  SDses,# Socioeconomic Status (SES)
  SDhhincomez,# Monthly HH net income in Quintilen (imputiert)
  SDisced11,# ISCED (2011) - Education groups
  SDhvtypD,# Main earner in household
  SDerwt0a,# Current life situation
  SDmainstat,# Employment (EHIS)
  SDalo,# Unemployed i.d.l. 5 years
  MIbirthplace,# Country of Birth (EHIS)
  MIcitizen,# Nationality
  untm,# examination month
  untj,# Year of examination
  ppoint,# Pseudo Sample Point
  ktyp4,# Settlement structural district type (BBSR)
  bula,# federal state
  wob# West/East/Berlin

)

```

## Data preparation {#dataprep}

### Missing values

Within the survey, branching of questions exists. That means that for certain groups of people, a subset of the data is not available by design. 

Also, other fields are omitted by individual choice. The following chart illustrates that this is true to a high degree for certain fields. This is because some questions are only being asked to elderly people for instance. 

```{r, echo=FALSE}
aggr(df_base, numbers = FALSE, prop = c(TRUE, FALSE))
```

We omitted those variables as of now and reduced only to the ones with all fields filled. 

```{r}

df_analysis <- df_base %>% dplyr::select(
  -c(
    BBhh5, 
    BBhh6, 
    IPinfl4_mm,
    IPinfl4_jj,
    SEschwA_zz,
    IAkfutyp5B_lz,
    IAkfutyp7B_lz,
    AUarbzD_k,
    
    BBschwierig4,
    BBschwierig1,
    BBschwierig2,		
    BBschwierig3,			
    BBschwierig5,		
    BBhh4,	
    BBhh7,		
    BBhh1,			
    BBhh2,			
    BBhh3
  )
)

df_analysis <- na.omit(df_analysis)

df_analysis <-  df_analysis[complete.cases(df_analysis),]

```

Therefore, we end up with a dataframe for the analysis of `r dim(df_analysis)[1]` observations and `r dim(df_analysis)[2]`. As double-check, no missing values exist anymore: 


```{r}

aggr(df_analysis, numbers = FALSE, prop = c(TRUE, FALSE))
```


As the following summary indicates, there are different types of categorical predictors: 
(a) binary ones JA/NEIN (Yes/No)
(b) multi-class, for instance: 

[SHseh1]    
Mittelmäßig       :6355   
Stark             :5783  
Sehr stark        :1147  
Weniger stark     : 828                                                          
Gar nicht         :  95                                                          
Keine Angabe_(-99):   0                                                          
(Other)           :   0 


```{r echo=FALSE }
# summary(df_analysis)
```

We clean unused levels within the data. 

```{r}

df_analysis <- df_analysis %>% droplevels

fac <- sapply(df_analysis, levels)

bool_fac <- fac[lapply(fac, length) == 2]

df_analysis$GZmehm1 <- factor(df_analysis$GZmehm1, c("Sehr schlecht",  "Schlecht", "Mittelmäßig","Gut", "Sehr gut"))
```

## Data Analysis {#analysis}

We assume that it is indeed an ordinal scaled response, which means that the difference between the levels of outcomes is equidistant (from bad -> mediocre == good -> very good). 

Also, we try to estimate the effect of predictors to change the outcome **one** level upwards. 

For simplistic reasons, we start with a basic model with only one predictor to ensure correct interpretability. We build a model that estimates the wellbeing state in dependence of **KHhyp** (Hypertension: Ever diagnosed by a doctor). 

### (M1_basic) Run a basic ordered logit model 

One of the assumptions underlying ordinal logistic (and ordinal probit) regression is that the relationship between each pair of outcome groups is the same. In other words, ordinal logistic regression assumes that the coefficients that describe the relationship between, say, the lowest versus all higher categories of the response variable are the same as those that describe the relationship between the next lowest category and all higher categories, etc. This is called the proportional odds assumption or the parallel regression assumption. Because the relationship between all pairs of groups is the same, there is only one set of coefficients.

Souce: https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/

```{r}

df_test <- df_analysis %>% dplyr::select(GZmehm1, KHhyp)

df_test$KHhyp <- as.character(df_test$KHhyp)

df_test[!is.na(df_test$KHhyp) & df_test$KHhyp == 'Ja',]$KHhyp <- '1'
df_test[!is.na(df_test$KHhyp) & df_test$KHhyp == 'Nein',]$KHhyp <- '0'

df_test$KHhyp <- as.numeric(df_test$KHhyp)

df_test <- na.omit(df_test)

m <- polr(GZmehm1 ~ KHhyp, data = df_test, Hess=TRUE)

summary(m)

```
Calculating the p-values for the coefficient of **KHhyp** reveals that it is highly statistically relevant. 

```{r calculating p-values}

ctable <- coef(summary(m))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))
```

Calculating the odds ratio to enable percentage interpretation.

```{r Odds Ratios}
exp(coef(m))
```


**Q1**: {#Q1}
As of now, the interpretation would be: 
For people that have higher blood pressure, the odds of feeling healthier are 75% lower compared to the people that do not have high BP. 

**Q2**: {#Q2}
Can we assume a-priori that the response (5-step likert scale) is holding against the parallel slopes assumption **by design** or do we need to validate this statistically?

If so, the following would force the 5-step scale into a binary classification and tries to analyze if the effect of the steps between y>=2 == y<=3. 

```{r}
sf <- function(y) {
  c('Y>=1' = qlogis(mean(y >= 1)),
    'Y>=2' = qlogis(mean(y >= 2)),
    'Y>=3' = qlogis(mean(y >= 3)),
    'Y>=4' = qlogis(mean(y >= 4)),
    'Y>=5' = qlogis(mean(y >= 5))
    )
}

(s <- with(df_test, summary(as.numeric(GZmehm1) ~ KHhyp, fun=sf)))
```

If we were to test it - the following plot would try to estimate the logit effect of the coefficient across the previously calculated "forced binary splits" 

**Q2b**: {#Q2b}
What would the interpretation be if the distance is not equal?

```{r}
plot(s, which=1:5, pch=1:5, xlab='logit', main=' ', xlim=range(s[,4:5]))
```


### (M2_binary_class) Model with only YES/NO questions as predictors as first level of analysis

Due to the uncertainty of how to interpret multi-class predictors within the ordered logit, we first built a model with binary predictors approximating the state of wellbeing. 

**Q3**: {#Q3}
How do we incorporate and interpret multi-class categorical predictors?

```{r}

m_b <- polr(GZmehm1 ~ KHhyp12+KHhyp+KHhyp12pB+KHhypmedC+KHmyo12+KHkhk12+KHbbmyo12+KHhi12+KHsa12+KHbbsa12+KHdiabB12+KHab12+KHkarz12+KHlip12A+KHlipA+KHlipmedA+KHcb12+KHulc12+KHced12+KHlz12+KHcle12+KHniB12+KHdge12+KHra12+KHos12+KHalgi112+GZmehm3C+BBmyo12+BBsa12+BBdors112+BBdors212+BBblas12B+BBbehB+UVartverkehr+UVarthaus+UVartfreiz+UVarbeit1+PKdep12+IAarzt8C+IAkhs+IAambC+IAther2B+IApflege+IPtet+AMarztB+AMfrei+KAabka+KAsabka+KAgfka+KAgfa+KAgfka1+KAgfmk+KAgka+AKbingeC_k3+BLpflege2C+sex+PAfam3+PAmarstadefacto+SDalo, data = df_analysis, Hess=TRUE)

summary(m_b)
```

Calculating p-values indicates various highly significant predictors. 

```{r calculating p-values basic model}

ctable <- coef(summary(m_b))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
ctable <- cbind(ctable, "p value" = p)


head(ctable) %>%
  kable() %>%
  kable_styling()

```


```{r}
factorlist <- exp(coef(m_b))
head(factorlist, 5)
```

## Questions {#questions}

* [Q1](#Q1): Would the interpretation of the coefficient be corret?
* [Q2](#Q2): Do we need to proof the parallel slope assumption?
* [Q3](#Q3): How do we deal with multi-class categorical predictors?
* Q4: Despite a categorical outcome of the response, can we still use LASSO as a means of feature selection?
